<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Getting Started: Serving Web Content</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/compat.js"></script>
    <script src="/js/bundle.js"></script>
    <script src="/js/download.js"></script>
</head>
<body>
    <table class="table table-hover">
        <thead>
            <tr>
                <td>From</td>
                <td>To</td>
                <td>Headers</td>
                <td>Content</td>
            </tr>
        </thead>
        <tbody>
            <tr class="mail-row" th:each="mail : ${mails}">
                <td th:id="'mail-from-' + ${mail.id}"></td>
                <td th:id="'mail-to-' + ${mail.id}"></td>
                <td class="mail-infos" th:id="'mail-infos-' + ${mail.id}"></td>
                <td class="mail-content" th:id="'mail-content-' + ${mail.id}" th:text="${mail.content}"></td>
                <script th:inline="javascript">
                    /*<![CDATA[*/

                    var mailAttachments = []

                    $(document).ready(function() {
                        var headers = JSON.parse(/*[[${mail.headers}]]*/ "");
                        var content = /*[[${mail.content}]]*/ "";

                        var fullMail = "";
                        for(var i = 0; i < headers.length; i++) {
                            fullMail += headers[i].key + ": " + headers[i].value + '\n';
                        }
                        fullMail += ('\n' + content);

                        window.mailParser(fullMail, function(err, mail) {

                            var links = "";

                            for(var i = 0; i < mail.attachments.length; i++) {
                                (function (attachment) {
                                    var index = /*[[${mail.id}]]*/ "";
                                    mailAttachments["mail-attachment-" + attachment.checksum] = {
                                        download: function() {
                                            download(attachment.content, attachment.filename, attachment.contentType)
                                        },
                                        info: {
                                            name: attachment.filename,
                                            checksum: attachment.checksum
                                        }
                                    };
                                    links += "<a href='javascript:mailAttachments[\"mail-attachment-" + attachment.checksum + "\"].download()'>" + attachment.filename + "</a><br />"
                                })(mail.attachments[i])
                            }

                            $("#mail-content-" + /*[[${mail.id}]]*/ "").html(mail.html)
                            $("#mail-from-"  + /*[[${mail.id}]]*/ "").html(mail.from.html)
                            $("#mail-to-"  + /*[[${mail.id}]]*/ "").html(mail.to.html)
                            $("#mail-infos-" + + /*[[${mail.id}]]*/ "").html("Subject : " + mail.subject + "<br />" +
                                "Date : " + mail.date.toLocaleString() + "<br />" +
                                "Attachments : "  + links)
                        });
                    })
                    /*]]>*/
                </script>
            </tr>
        </tbody>
    </table>
</body>
</html>